---
title: 05/17
tags: diary
---

TAOCP アルゴリズム 2.2T (トポロジカルソート) を実装した。   
MIXはIO込みでたったの75行で実装しているというのに、高級言語のRustで実装したコードをアセンブリに変換すると600行程度になり非常に悲しかった。
もちろん命令セットの違いはあるけれど、それ以上に、MIX ver. ではRustで非常に書きにくいunsafeなロジックがたくさんあったのも原因の一つだろう。

1. 1ワードにcount, topという情報を詰める
1. countをqlinkにすりかえる
    * step2において、countをmutable参照している時に他の場所でcountを書き換えないといけなくて厳しい
    * よく考えたら `mut_iter()` じゃなくて普通にインデックスでアクセスしていればいけたか。

あれ？もしかしてunsafeじゃない？手癖で書いて勝手にあきらめてた？   

```rust
pub fn topsort(n: usize, graph: &Vec<(usize, usize)>) -> Vec<usize> {
    // Step 0. check input
    //     graph's vertex index is in 1..=n.
    //     graph is DAG

    // Step 1. preprocessing
    let mut count = vec![0usize; n + 1];
    let mut top = vec![LinkedList::new(); n + 1];
    for (src, dst) in graph {
        count[*dst] += 1;
        top[*src].push_front(*dst);
    }

    // Step 2. find zero count
    let mut qlink = LinkedList::new();
    for (i, c) in count.iter().enumerate() {
        if i != 0 && *c == 0 {
            qlink.push_back(i);
        }
    }

    // Step 3. main sort
    let mut ret = vec![];
    loop {
        let f = match qlink.pop_front() {
            Some(v) => v,
            None => break,
        };
        ret.push(f);
        for dst in top[f].iter() {
            count[*dst] -= 1;
            if count[*dst] == 0 {
                qlink.push_back(*dst);
            }
        }
    }
    ret
}
```
