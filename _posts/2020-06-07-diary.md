---
title: 06/07
tags: diary
---

MIXのエミュレータを実装しているうちに、言語処理系の勉強意欲が高まった。
Rustで言語実装している例を探してみたら、「Go言語でつくるインタプリタ」をRustで実装しているスライドを見つけた。
良さそうな雰囲気だったので真似することにした。

* [Monkey-Rust](<https://github.com/cocococoa/Monkey-Rust>)

GoのコードをRustに移植する感じかなと予想していたが、根本的に異なるデータ構造を選択した結果、気合で実装することになってしまった。
具体的には、Rustの自転車本を大いに参考にしたデータ構造で実装したのだけれど、トークンの位置やエラー処理をきちんと行う前提のデータ構造で、これは初心者には非常につらかった。
そして結局エラー処理は実装しきれなかった。

今は(諸々ひどい)パーサが一通り完成したところで、ひとまず次のステップ、意味解析に移ろうと思う。

パーサの勉強をした感想を置いておく。   
この教科書は式をトップダウン演算子順位解析(Pratt構文解析 ([論文](<https://tdop.github.io/>)))という手法でパースする。   
特徴は次の通り。

1. トークンを二個見ながらパースする
    * 「今のトークン」と「次のトークン」を見ながらパース
1. 式をパースするとき、「現在の優先度」を保持しながらパースする
1. パース中、中置演算子に出会ったとき、「現在の優先度」と「中置演算子の優先度」をつきあわせて、木構造を構築する
    * 現在の優先度は(中置演算子にとっての)左の項の「(中置演算子にとっての)右の項との離れたさ」
    * 中置演算子の優先度は(中置演算子にとっての)右の項の「(中置演算子にとっての)左の項とのくっつきたさ」
    * 要するに、中置演算子が見つかるたびに左の木と右の木のどちらを上に置くべきかということを上手いこと決めている
    * お気持ちだけ書くから分かりにくいけれど、教科書を読めば良く分かる

教科書では激推しだったけれど、Monkeyではすべての中置演算子は左結合だから実装がシンプルになったのであって、そうでなければ結構込み入った実装になるしちょっと微妙な構文解析手法だと思った。

---

以前の僕は理論的勉強から入る傾向にあったから、「言語実装パターン」や「コンパイラ　原理・技法・ツール」をチョイスしていたと思うけど、
TAOCPに出会って、手を動かす喜びをちょっとわかった気がする。良いことか悪いことかは良く知らないけれど。

社会人ぱわーでたくさん本を買っちゃった。読めるのだろうか？

<img class="image image--xl" src="https://github.com/cocococoa/cocococoa.github.io/blob/master/images/2020-06-07-01.jpg?raw=true"/>
